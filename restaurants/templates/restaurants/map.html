{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Finder</title>
    <link rel="stylesheet" href="{% static 'restaurants/style.css' %}">

    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
        }
        #searchForm {
            margin-bottom: 20px;
        }
        button, input {
            margin: 5px;
        }
        #results {
            list-style-type: none;
            padding: 0;
        }
        .review {
            border-bottom: 1px solid #ccc; /* Add a line to separate reviews */
            padding: 5px 0; /* Add some padding */
        }
        .review strong {
            color: #333; /* Style the reviewer name */
        }
        .restaurant-list {
            margin-top: 20px;
        }
    </style>
</head>
<header>
    {% include 'restaurants/banner.html' %}

</header>
<body>
    <h1 id="ugly">Find Food Near You</h1>

    <!-- Button to get user's location -->
    <button onclick="getUserLocation()">Find My Location</button>
    <a href="{% url 'home' %}" class="return-homepage">Return to Homepage</a>

    <!-- Search form -->
    <form id="searchForm">
        <input type="text" id="searchName" placeholder="Search for restaurants..." autocomplete="off">
        <button type="button" onclick="performSearch()">Search</button>
        <button type="button" onclick="viewInList()">View in List</button>
    </form>

    <!-- Map container -->
    <div id="map"></div>

    <!-- Restaurant list section -->
    <div class="restaurant-list">
        <h3>Restaurant List</h3>
        <select id="sortBy" onchange="sortRestaurants()">
            <option value="rating">Sort by Rating</option>
            <option value="distance">Sort by Distance</option>
        </select>
        <ul id="restaurantList"></ul>
    </div>

    <!-- JavaScript code -->
    <script>
        let map;
        let allMarkers = [];
        let userLocation = null;
        let service;
        let infowindow;
        let autocomplete;
        let restaurantData = []; // Store restaurant data for the list

        function initMap() {
            const location = { lat: 33.749, lng: -84.388 }; // Atlanta coordinates
            map = new google.maps.Map(document.getElementById('map'), {
                center: location,
                zoom: 12,
                disableDefaultUI: true,
            });

            // Initialize the Places service and info window
            service = new google.maps.places.PlacesService(map);
            infowindow = new google.maps.InfoWindow();

            // Initialize Autocomplete
            autocomplete = new google.maps.places.Autocomplete(document.getElementById('searchName'));
            autocomplete.bindTo('bounds', map);
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    alert("No details available for input: '" + place.name + "'");
                    return;
                }
                map.setCenter(place.geometry.location);
                map.setZoom(15); // Zoom in on the selected place
                clearMarkers();
                createMarker(place); // Optionally create a marker for the selected place
            });
        }

        // Perform search using TextSearchService
        function performSearch() {
            const query = document.getElementById('searchName').value;

            if (!query) {
                alert("Please enter a search query.");
                return;
            }

            // Create request for the Places API Text Search
            const request = {
                query: query,
                location: map.getCenter(),
                radius: 5000, // 5 km radius
            };

            service.textSearch(request, handleSearchResults);
        }

        // Handle the search results from the Places API
        function handleSearchResults(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                clearMarkers(); // Clear previous markers
                restaurantData = []; // Clear previous restaurant data
                results.forEach(place => {
                    createMarker(place);
                    restaurantData.push({
                        name: place.name,
                        rating: place.rating || 'N/A',
                        address: place.formatted_address,
                        location: place.geometry.location,
                    });
                });
                updateRestaurantList(); // Update the restaurant list
            } else {
                alert("No results found.");
            }
        }

        // Create markers for each result
        function createMarker(place) {
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name,
            });

            // Store the marker for later filtering
            allMarkers.push(marker);

            // Add click listener to show details in info window
            google.maps.event.addListener(marker, 'click', () => {
                service.getDetails({ placeId: place.place_id }, (details, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        const content = `
                            <h3>${details.name}</h3>
                            <p>Rating: ${details.rating || 'N/A'}</p>
                            <p>Address: ${details.formatted_address}</p>
                            <p>Cuisine: ${details.types?.join(', ') || 'N/A'}</p>
                            <h4>Reviews:</h4>
                            <div class="reviews">${formatReviews(details.reviews)}</div>
                            <p>Phone: ${details.formatted_phone_number || 'N/A'}</p>
                        `;
                        infowindow.setContent(content);
                        infowindow.open(map, marker);
                    }
                });
            });
        }

        // Format reviews for better readability
        function formatReviews(reviews) {
            if (!reviews || reviews.length === 0) return 'No reviews available';
            return reviews.map(review => `
                <div class="review">
                    <strong>${review.author_name}</strong> - ${'â˜…'.repeat(Math.round(review.rating))} (${review.rating} stars)
                    <p>${review.text}</p>
                </div>
            `).join('');
        }

        // Clear all markers from the map
        function clearMarkers() {
            allMarkers.forEach(marker => marker.setMap(null));
            allMarkers = [];
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function success(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            userLocation = { lat: latitude, lng: longitude };

            map.setCenter(userLocation);

            // Save user's location (if needed)
            fetch('/save_location/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ latitude: latitude, longitude: longitude })
            }).then(response => response.json())
              .then(data => console.log('Location saved:', data))
              .catch(error => console.error('Error saving location:', error));
        }

        function error() {
            alert("Unable to retrieve your location.");
        }

        // Function to update the restaurant list display
        function updateRestaurantList() {
            const restaurantList = document.getElementById('restaurantList');
            restaurantList.innerHTML = ''; // Clear previous list

            restaurantData.forEach(restaurant => {
                const li = document.createElement('li');
                li.innerText = `${restaurant.name} - Rating: ${restaurant.rating}, Address: ${restaurant.address}`;
                restaurantList.appendChild(li);
            });
        }

        // Function to view restaurant list on a new page
        function viewInList() {
            const restaurantListHtml = restaurantData.map(restaurant =>
                `<li>${restaurant.name} - Rating: ${restaurant.rating}, Address: ${restaurant.address}</li>`
            ).join('');
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                <head>
                    <title>Restaurant List</title>
                </head>
                <body>
                    <h1>Restaurant List</h1>
                    <ul>${restaurantListHtml}</ul>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        // Function to sort restaurants
        function sortRestaurants() {
            const sortBy = document.getElementById('sortBy').value;

            if (sortBy === 'rating') {
                restaurantData.sort((a, b) => b.rating - a.rating);
            } else if (sortBy === 'distance') {
                // Assuming userLocation is set, you could implement a distance calculation here.
                restaurantData.sort((a, b) =>
                    google.maps.geometry.spherical.computeDistanceBetween(a.location, userLocation) -
                    google.maps.geometry.spherical.computeDistanceBetween(b.location, userLocation)
                );
            }
            updateRestaurantList(); // Update the list display after sorting
        }

        // Initialize the Google Maps API
        window.initMap = initMap;
    </script>

     <!-- Replace 'YOUR_API_KEY' with your actual Google Maps API key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArjK69M4dg5Mdy8e_LukUKUgL2TOGNucs&libraries=places&callback=initMap"></script>
</body>
</html>
